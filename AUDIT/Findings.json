[
  {
    "id": "CRIT-001",
    "severity": "CRITICAL",
    "area": "Security",
    "file": "supabase/functions/*/index.ts",
    "line": "multiple",
    "evidence": "Access-Control-Allow-Origin: '*'",
    "impact": "Allows requests from any origin, increases CSRF and data scraping risks",
    "recommendation": "Replace wildcard with whitelist of allowed origins (fixco.se, www.fixco.se)",
    "risk_if_changed": "Low - requires environment-specific origin list",
    "related": ["CRIT-008"]
  },
  {
    "id": "CRIT-002",
    "severity": "CRITICAL",
    "area": "Logging",
    "file": "src/**/*.{ts,tsx}",
    "line": "349 occurrences across 104 files",
    "evidence": "console.log/warn/error in production code",
    "impact": "Exposes PII (email, phone, org numbers) in browser console, performance overhead",
    "recommendation": "Create conditional logger utility that only logs in development",
    "risk_if_changed": "Minimal - systematic search-replace",
    "related": ["CRIT-008"]
  },
  {
    "id": "CRIT-003",
    "severity": "CRITICAL",
    "area": "Routing",
    "file": "src/App.tsx",
    "line": "176, 183",
    "evidence": "<Route path=\"jobs\" element={<AdminJobs />} /> appears twice",
    "impact": "Second route is dead code, potential confusion in future updates",
    "recommendation": "Remove duplicate route definition",
    "risk_if_changed": "None - second is already unused",
    "related": []
  },
  {
    "id": "CRIT-004",
    "severity": "HIGH",
    "area": "Database",
    "file": "src/integrations/supabase/types.ts, supabase/functions/generate-quote-pdf/index.ts",
    "line": "2809, 31",
    "evidence": "References to 'quote_requests' table that doesn't exist in current schema",
    "impact": "Risk of calling non-existent endpoints, technical debt, confusion",
    "recommendation": "Remove all quote_requests references, document that only quotes_new should be used",
    "risk_if_changed": "Low if table already removed from prod DB",
    "related": ["MED-002"]
  },
  {
    "id": "CRIT-005",
    "severity": "CRITICAL",
    "area": "Edge Functions",
    "file": "supabase/functions/send-quote-email-new/index.ts",
    "line": "42",
    "evidence": "const publicUrl = `${frontendUrl}/quote/${quote.public_token}`;",
    "impact": "Wrong URL - correct route is /q/:token not /quote/:token. Customers get 404 on email links",
    "recommendation": "Change to: const publicUrl = `${frontendUrl}/q/${quote.public_token}`;",
    "risk_if_changed": "None - this is a bug fix",
    "related": []
  },
  {
    "id": "HIGH-001",
    "severity": "HIGH",
    "area": "UI/UX",
    "file": "src/components/AIFunctionModals.tsx, src/pages/MyFixco/AdminDatabase.tsx, etc",
    "line": "242, 80, 232",
    "evidence": "JSON.stringify used to display data directly to users",
    "impact": "Poor UX, hard to read for non-technical users, exposes internal structures",
    "recommendation": "Replace with formatted components or pretty-printed JSON in <pre> blocks",
    "risk_if_changed": "Minimal - UI improvement only",
    "related": []
  },
  {
    "id": "HIGH-002",
    "severity": "HIGH",
    "area": "Error Handling",
    "file": "supabase/functions/create-booking-with-quote/index.ts",
    "line": "49-52, and others",
    "evidence": "if (custErr) throw custErr without try-catch wrapper",
    "impact": "Generic 500 errors without useful messages for client debugging",
    "recommendation": "Wrap all edge function bodies in try-catch with structured error responses",
    "risk_if_changed": "Minimal - improves error handling",
    "related": []
  },
  {
    "id": "HIGH-003",
    "severity": "HIGH",
    "area": "GDPR/Privacy",
    "file": "supabase/functions/create-booking-with-quote/index.ts, send-quote-email-new/index.ts, src/components/ActionWizard.tsx",
    "line": "50, 67, 21, 80, 112, 125",
    "evidence": "PII (email, phone, org numbers) logged to console",
    "impact": "GDPR violation, security risk if logs stored unencrypted",
    "recommendation": "Remove PII from logs or hash/anonymize before logging",
    "risk_if_changed": "Low - replace with safe alternatives",
    "related": ["CRIT-002"]
  },
  {
    "id": "HIGH-004",
    "severity": "HIGH",
    "area": "API",
    "file": "src/lib/api/quotes.ts (missing), src/lib/api/quotes-new.ts (active)",
    "line": "N/A",
    "evidence": "Duplicate API files reference - quotes.ts doesn't exist but quotes-new.ts does",
    "impact": "Confusion about which API to use, risk of using old endpoints",
    "recommendation": "Search for old imports, replace with quotes-new.ts, document migration",
    "risk_if_changed": "Low if no one uses old file",
    "related": ["CRIT-004"]
  },
  {
    "id": "HIGH-005",
    "severity": "HIGH",
    "area": "Performance",
    "file": "Multiple components using supabase.channel()",
    "line": "useQuotesRealtime, useJobsRealtime hooks",
    "evidence": "Realtime channels may not cleanup properly on unmount",
    "impact": "Memory leaks, increased connections to Supabase, performance degradation",
    "recommendation": "Verify all useEffect with .channel() have removeChannel in cleanup",
    "risk_if_changed": "Minimal - standard React pattern",
    "related": []
  },
  {
    "id": "MED-001",
    "severity": "MEDIUM",
    "area": "Routing",
    "file": "src/App.tsx",
    "line": "220, 256",
    "evidence": "Duplicate /cookies routes under both Swedish and English paths",
    "impact": "Potential route conflicts",
    "recommendation": "Verify routing logic and consolidate if needed",
    "risk_if_changed": "Low",
    "related": []
  },
  {
    "id": "MED-002",
    "severity": "MEDIUM",
    "area": "SEO/A11y",
    "file": "Multiple image components",
    "line": "Various",
    "evidence": "Images without descriptive alt attributes",
    "impact": "Poor SEO, inaccessible to screen readers",
    "recommendation": "Add descriptive alt text to all images",
    "risk_if_changed": "Minimal",
    "related": []
  },
  {
    "id": "MED-003",
    "severity": "MEDIUM",
    "area": "Database/RLS",
    "file": "Database schema - dispatch_queue table",
    "line": "RLS policy",
    "evidence": "Only admin/owner can access dispatch_queue",
    "impact": "Workers/technicians who need read access will get permission errors",
    "recommendation": "Add SELECT policy for workers: WHERE EXISTS(SELECT 1 FROM jobs WHERE assigned_worker_id = auth.uid())",
    "risk_if_changed": "Low - adds necessary permissions",
    "related": []
  },
  {
    "id": "MED-004",
    "severity": "MEDIUM",
    "area": "Database",
    "file": "quotes_new, bookings, jobs, projects tables",
    "line": "deleted_at column",
    "evidence": "Soft delete implemented but no automatic cleanup",
    "impact": "Old deleted records accumulate, using disk space",
    "recommendation": "Create cron job or scheduled function to run empty_*_trash RPCs monthly",
    "risk_if_changed": "Minimal",
    "related": []
  },
  {
    "id": "MED-005",
    "severity": "MEDIUM",
    "area": "Edge Functions",
    "file": "supabase/functions/send-quote-email-new/index.ts",
    "line": "100",
    "evidence": "from: 'Fixco <onboarding@resend.dev>'",
    "impact": "Unprofessional, may trigger spam filters",
    "recommendation": "Change to from: 'Fixco <offert@fixco.se>' or noreply@fixco.se",
    "risk_if_changed": "Low - requires email domain verification",
    "related": []
  },
  {
    "id": "MED-006",
    "severity": "MEDIUM",
    "area": "Security",
    "file": "All edge functions",
    "line": "N/A",
    "evidence": "No rate limiting implemented",
    "impact": "Risk of abuse/DoS attacks",
    "recommendation": "Implement rate limiting middleware using Upstash Redis or similar",
    "risk_if_changed": "Medium - requires infrastructure setup",
    "related": []
  },
  {
    "id": "LOW-001",
    "severity": "LOW",
    "area": "Performance",
    "file": "src/components/admin/*",
    "line": "Multiple admin components",
    "evidence": "Admin components loaded synchronously",
    "impact": "Larger initial bundle size",
    "recommendation": "Lazy load entire admin section with React.lazy()",
    "risk_if_changed": "Low",
    "related": []
  },
  {
    "id": "LOW-002",
    "severity": "LOW",
    "area": "Performance",
    "file": "src/pages/admin/AdminQuotes.tsx, AdminJobs.tsx, AdminBookings.tsx",
    "line": "List rendering",
    "evidence": "Large lists render all items at once",
    "impact": "Slow rendering with 100+ items",
    "recommendation": "Implement virtualization with react-window or @tanstack/virtual",
    "risk_if_changed": "Low",
    "related": []
  },
  {
    "id": "LOW-003",
    "severity": "LOW",
    "area": "State Management",
    "file": "src/components/EditableServiceFilter.tsx, FastServiceFilter.tsx",
    "line": "237, 232",
    "evidence": "sessionStorage used for filter state",
    "impact": "State lost in incognito/on clear",
    "recommendation": "Consider persisting in URL query params instead",
    "risk_if_changed": "Low",
    "related": []
  },
  {
    "id": "LOW-004",
    "severity": "LOW",
    "area": "Security",
    "file": "src/components/SecurityWrapper.tsx",
    "line": "Multiple",
    "evidence": "No CSP (Content Security Policy) header",
    "impact": "Missing defense against XSS attacks",
    "recommendation": "Add strict CSP header",
    "risk_if_changed": "Medium - may break inline scripts",
    "related": []
  },
  {
    "id": "LOW-005",
    "severity": "LOW",
    "area": "Security",
    "file": "supabase/functions/ai-chat/index.ts",
    "line": "15",
    "evidence": "No input validation with schema",
    "impact": "Potential injection attacks",
    "recommendation": "Add Zod validation for messages and tools parameters",
    "risk_if_changed": "Low",
    "related": []
  },
  {
    "id": "LOW-006",
    "severity": "LOW",
    "area": "Security",
    "file": "supabase/functions/create-booking-with-quote/index.ts",
    "line": "35",
    "evidence": "fileUrls accepted without MIME type validation",
    "impact": "Risk of uploading executable files",
    "recommendation": "Add MIME type check and file size validation",
    "risk_if_changed": "Low",
    "related": []
  },
  {
    "id": "LOW-007",
    "severity": "LOW",
    "area": "Performance",
    "file": "src/pages/admin/AdminQuotes.tsx",
    "line": "177",
    "evidence": "filteredQuotes recalculated every render",
    "impact": "Unnecessary re-computation",
    "recommendation": "Wrap in useMemo with proper dependencies",
    "risk_if_changed": "Minimal",
    "related": []
  },
  {
    "id": "LOW-008",
    "severity": "LOW",
    "area": "Performance",
    "file": "package.json",
    "line": "45-46",
    "evidence": "@react-three/fiber and drei loaded even if SmartHome not used",
    "impact": "Larger bundle size",
    "recommendation": "Ensure SmartHome uses dynamic import only",
    "risk_if_changed": "Low",
    "related": []
  },
  {
    "id": "LOW-009",
    "severity": "LOW",
    "area": "Performance",
    "file": "src/pages/Referenser.tsx (inferred)",
    "line": "Image rendering",
    "evidence": "Reference project images loaded all at once",
    "impact": "Slow initial page load",
    "recommendation": "Add loading='lazy' or Intersection Observer",
    "risk_if_changed": "Minimal",
    "related": []
  },
  {
    "id": "LOW-010",
    "severity": "LOW",
    "area": "A11y",
    "file": "Multiple components",
    "line": "Icon-only buttons",
    "evidence": "Buttons without aria-label",
    "impact": "Inaccessible to screen readers",
    "recommendation": "Add aria-label to all icon-only buttons",
    "risk_if_changed": "Minimal",
    "related": []
  },
  {
    "id": "LOW-011",
    "severity": "LOW",
    "area": "A11y",
    "file": "Custom modal components",
    "line": "Various",
    "evidence": "Modals without aria-modal='true' and role='dialog'",
    "impact": "Poor screen reader support",
    "recommendation": "Add proper ARIA attributes to all modals",
    "risk_if_changed": "Minimal",
    "related": []
  },
  {
    "id": "LOW-012",
    "severity": "LOW",
    "area": "A11y",
    "file": "Modal components",
    "line": "onClose handlers",
    "evidence": "Focus not returned to trigger element after modal close",
    "impact": "Poor keyboard navigation experience",
    "recommendation": "Implement focus management on modal close",
    "risk_if_changed": "Low",
    "related": []
  }
]
